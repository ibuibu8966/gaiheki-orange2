generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Admin {
  id                           Int                            @id @default(autoincrement())
  username                     String                         @unique @db.VarChar(50)
  email                        String                         @unique @db.VarChar(100)
  passwordHash                 String                         @map("password_hash") @db.VarChar(255)
  role                         AdminRole                      @default(ADMIN)
  isActive                     Boolean                        @default(true) @map("is_active")
  lastLoginAt                  DateTime?                      @map("last_login_at")
  createdAt                    DateTime                       @default(now()) @map("created_at")
  updatedAt                    DateTime                       @updatedAt @map("updated_at")
  sessions                     AdminSession[]
  application_status_histories application_status_histories[]
  articles                     articles[]
  partner_applications         partner_applications[]
  deposit_requests             DepositRequest[]

  @@map("admins")
}

model AdminSession {
  id        String   @id @default(cuid())
  adminId   Int      @map("admin_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([expiresAt])
  @@map("admin_sessions")
}

model application_status_histories {
  id                   Int                  @id @default(autoincrement())
  application_id       Int
  previous_status      ApplicationStatus?
  new_status           ApplicationStatus
  changed_by           Int
  change_reason        String?
  created_at           DateTime             @default(now())
  partner_applications partner_applications @relation(fields: [application_id], references: [id], onDelete: Cascade)
  admins               Admin                @relation(fields: [changed_by], references: [id])
}

model articles {
  id              Int             @id @default(autoincrement())
  admin_id        Int
  title           String          @db.VarChar(200)
  thumbnail_image String?         @db.Text
  category        ArticleCategory
  content         String          @db.Text
  is_published    Boolean         @default(false)
  sort_order      Int             @default(0)
  post_name       String          @db.VarChar(100)
  created_at      DateTime        @default(now())
  updated_at      DateTime
  admins          Admin           @relation(fields: [admin_id], references: [id])
}

model customers {
  id                         Int                      @id @default(autoincrement())
  partner_id                 Int
  customer_name              String                   @db.VarChar(100)
  customer_phone             String                   @db.VarChar(20)
  customer_email             String                   @db.VarChar(150)
  construction_address       String                   @db.VarChar(500)
  customer_construction_type CustomerConstructionType
  construction_amount        Int
  construction_completed_at  DateTime?
  customer_status            CustomerStatus           @default(ORDERED)
  customer_completion_date   DateTime?
  customer_rating            Int?                     @db.SmallInt
  customer_review_title      String?                  @db.VarChar(200)
  customer_review            String?
  customer_review_date       DateTime?
  customer_comment           String?
  created_at                 DateTime                 @default(now())
  updated_at                 DateTime
  partners                   partners                 @relation(fields: [partner_id], references: [id])
  diagnosis_requests         diagnosis_requests[]
  inquiries                  inquiries[]
}

model diagnosis_requests {
  id                    Int              @id @default(autoincrement())
  diagnosis_number      String           @unique @db.VarChar(20)
  customer_id           Int
  designated_partner_id Int?
  prefecture            Prefecture
  floor_area            FloorArea
  current_situation     CurrentSituation
  construction_type     ConstructionType
  status                DiagnosisStatus  @default(RECRUITING)
  created_at            DateTime         @default(now())
  updated_at            DateTime

  // 新規追加フィールド（ヒアリング情報・紹介システム）
  customer_enthusiasm     Int?    @map("customer_enthusiasm") @db.SmallInt
  desired_partner_count   Int?    @default(3) @map("desired_partner_count")
  referral_fee            Int     @default(30000) @map("referral_fee")
  admin_note              String? @map("admin_note") @db.Text
  customer_address        String? @map("customer_address") @db.VarChar(500)
  customer_phone_verified String? @map("customer_phone_verified") @db.VarChar(20)

  customers          customers        @relation(fields: [customer_id], references: [id])
  designated_partner partners?        @relation("DesignatedDiagnoses", fields: [designated_partner_id], references: [id])
  quotations         quotations[]
  referrals          Referral[]
  deposit_histories  DepositHistory[]
}

model inquiries {
  id              Int           @id @default(autoincrement())
  customer_id     Int
  subject         String        @db.VarChar(200)
  inquiry_content String
  inquiry_status  InquiryStatus @default(PENDING)
  admin_memo      String?
  created_at      DateTime      @default(now())
  updated_at      DateTime
  customers       customers     @relation(fields: [customer_id], references: [id])
}

model orders {
  id                       Int                @id @default(autoincrement())
  quotation_id             Int                @unique
  partner_memo             String?
  admin_memo               String?
  construction_amount      Int?
  construction_start_date  DateTime?          @db.Date
  construction_end_date    DateTime?          @db.Date
  order_status             OrderStatus        @default(ORDERED)
  order_date               DateTime           @default(now())
  completion_date          DateTime?
  evaluation_token         String?            @unique @db.VarChar(100)
  evaluation_token_sent_at DateTime?
  created_at               DateTime           @default(now())
  updated_at               DateTime
  quotations               quotations         @relation(fields: [quotation_id], references: [id])
  order_photos             order_photos[]
  customer_invoices        customer_invoices?
}

model order_photos {
  id          Int      @id @default(autoincrement())
  order_id    Int
  photo_url   String   @db.VarChar(500)
  photo_type  String?  @db.VarChar(50)
  description String?  @db.VarChar(200)
  uploaded_at DateTime @default(now())
  created_at  DateTime @default(now())
  orders      orders   @relation(fields: [order_id], references: [id], onDelete: Cascade)

  @@index([order_id])
}

model partner_application_prefectures {
  id                   Int                  @id @default(autoincrement())
  partner_id           Int
  supported_prefecture Prefecture
  created_at           DateTime             @default(now())
  partner_applications partner_applications @relation(fields: [partner_id], references: [id], onDelete: Cascade)

  @@unique([partner_id, supported_prefecture])
}

model partner_applications {
  id                              Int                               @id @default(autoincrement())
  company_name                    String                            @db.VarChar(200)
  representative_name             String                            @db.VarChar(100)
  address                         String                            @db.VarChar(500)
  phone_number                    String                            @db.VarChar(20)
  email                           String                            @db.VarChar(150)
  website_url                     String?                           @db.VarChar(500)
  business_description            String
  self_pr                         String
  application_status              ApplicationStatus                 @default(UNDER_REVIEW)
  admin_memo                      String?
  review_notes                    String?
  reviewed_by                     Int?
  reviewed_at                     DateTime?
  created_at                      DateTime                          @default(now())
  updated_at                      DateTime
  application_status_histories    application_status_histories[]
  partner_application_prefectures partner_application_prefectures[]
  admins                          Admin?                            @relation(fields: [reviewed_by], references: [id])
}

model partner_details {
  id                          Int            @id @default(autoincrement())
  partner_id                  Int            @unique
  company_name                String         @db.VarChar(200)
  phone_number                String         @db.VarChar(20)
  address                     String         @db.VarChar(500)
  representative_name         String         @db.VarChar(100)
  fax_number                  String?        @db.VarChar(20)
  website_url                 String?        @db.VarChar(500)
  business_description        String
  appeal_text                 String
  business_hours              String?        @db.VarChar(200)
  closed_days                 String?        @db.VarChar(200)
  site_reprint_prefecture     Prefecture?
  partners_status             PartnersStatus @default(INACTIVE)
  invoice_registration_number String?        @db.VarChar(50)
  bank_name                   String?        @db.VarChar(255)
  bank_branch_name            String?        @db.VarChar(255)
  bank_account_type           String?        @db.VarChar(50)
  bank_account_number         String?        @db.VarChar(50)
  bank_account_holder         String?        @db.VarChar(255)
  created_at                  DateTime       @default(now())
  updated_at                  DateTime
  partners                    partners       @relation(fields: [partner_id], references: [id], onDelete: Cascade)
}

model partner_prefectures {
  id                   Int        @id @default(autoincrement())
  partner_id           Int
  supported_prefecture Prefecture
  created_at           DateTime   @default(now())
  updated_at           DateTime
  partners             partners   @relation(fields: [partner_id], references: [id], onDelete: Cascade)

  @@unique([partner_id, supported_prefecture])
}

model partners {
  id            Int       @id @default(autoincrement())
  username      String    @unique @db.VarChar(100)
  login_email   String    @unique @db.VarChar(150)
  password_hash String    @db.VarChar(255)
  is_active     Boolean   @default(true)
  last_login_at DateTime?
  fee_plan_id   Int?
  created_at    DateTime  @default(now())
  updated_at    DateTime

  // 新規追加フィールド（保証金・紹介システム）
  deposit_balance       Int       @default(0) @map("deposit_balance")
  monthly_desired_leads Int?      @map("monthly_desired_leads")
  monthly_leads_count   Int       @default(0) @map("monthly_leads_count")
  last_leads_reset      DateTime? @map("last_leads_reset")

  customers            customers[]
  partner_details      partner_details?
  partner_prefectures  partner_prefectures[]
  quotations           quotations[]
  designated_diagnoses diagnosis_requests[]  @relation("DesignatedDiagnoses")
  fee_plans            fee_plans?            @relation(fields: [fee_plan_id], references: [id])
  company_invoices     company_invoices[]
  deposit_histories    DepositHistory[]
  deposit_requests     DepositRequest[]
  referrals            Referral[]
}

model quotations {
  id                   Int                @id @default(autoincrement())
  diagnosis_request_id Int
  partner_id           Int
  quotation_amount     Int
  appeal_text          String?
  is_selected          Boolean            @default(false)
  created_at           DateTime           @default(now())
  updated_at           DateTime
  orders               orders?
  diagnosis_requests   diagnosis_requests @relation(fields: [diagnosis_request_id], references: [id])
  partners             partners           @relation(fields: [partner_id], references: [id])
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  OPERATOR
}

enum ApplicationStatus {
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum ArticleCategory {
  BASIC_KNOWLEDGE
  PAINT_TYPES
  CASE_STUDIES
  MAINTENANCE
  CONTRACTOR_SELECTION
  COST_ESTIMATE
  TROUBLESHOOTING
  SEASONAL_WEATHER
}

enum ConstructionType {
  EXTERIOR_PAINTING
  ROOF_PAINTING
  SCAFFOLDING_WORK
  WATERPROOFING
  LARGE_SCALE_WORK
  INTERIOR_WORK
  EXTERIOR_WORK
  OTHER

  // 非推奨（既存データ用に残す）
  EXTERIOR_AND_ROOF
  PARTIAL_REPAIR
  SIDING_REPLACEMENT
  FULL_REPLACEMENT
}

enum CurrentSituation {
  MARKET_RESEARCH
  CONSIDERING_CONSTRUCTION
  COMPARING_CONTRACTORS
  READY_TO_ORDER
  CONSTRUCTION_COMPLETED
}

enum CustomerConstructionType {
  EXTERIOR_PAINTING
  ROOF_PAINTING
  EXTERIOR_AND_ROOF
  PARTIAL_REPAIR
  WATERPROOFING
  SIDING_REPLACEMENT
  FULL_REPLACEMENT
}

enum CustomerStatus {
  ORDERED
  IN_PROGRESS
  COMPLETED
  REVIEW_COMPLETED
  CANCELLED
}

enum DiagnosisStatus {
  DESIGNATED
  RECRUITING
  COMPARING
  DECIDED
  CANCELLED
}

enum FloorArea {
  UNKNOWN
  UNDER_80
  FROM_80_TO_100
  FROM_101_TO_120
  FROM_121_TO_140
  FROM_141_TO_160
  FROM_161_TO_180
  FROM_181_TO_200
  FROM_201_TO_250
  FROM_251_TO_300
  FROM_301_TO_500
  OVER_501
}

enum InquiryStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum OrderStatus {
  ORDERED
  IN_PROGRESS
  COMPLETED
  REVIEW_COMPLETED
  CANCELLED
}

enum PartnersStatus {
  ACTIVE
  INACTIVE
}

enum Prefecture {
  Hokkaido
  Aomori
  Iwate
  Miyagi
  Akita
  Yamagata
  Fukushima
  Ibaraki
  Tochigi
  Gunma
  Saitama
  Chiba
  Tokyo
  Kanagawa
  Niigata
  Toyama
  Ishikawa
  Fukui
  Yamanashi
  Nagano
  Gifu
  Shizuoka
  Aichi
  Mie
  Shiga
  Kyoto
  Osaka
  Hyogo
  Nara
  Wakayama
  Tottori
  Shimane
  Okayama
  Hiroshima
  Yamaguchi
  Tokushima
  Kagawa
  Ehime
  Kochi
  Fukuoka
  Saga
  Nagasaki
  Kumamoto
  Oita
  Miyazaki
  Kagoshima
  Okinawa
}

enum InvoiceStatus {
  DRAFT
  UNPAID
  PAID
  OVERDUE
  CANCELLED
}

model customer_invoices {
  id             Int                      @id @default(autoincrement())
  invoice_number String                   @unique @db.VarChar(50)
  order_id       Int                      @unique
  issue_date     DateTime                 @db.Date
  due_date       DateTime                 @db.Date
  total_amount   Int
  tax_amount     Int
  grand_total    Int
  status         InvoiceStatus            @default(UNPAID)
  payment_date   DateTime?                @db.Date
  created_at     DateTime                 @default(now())
  updated_at     DateTime                 @updatedAt
  order          orders                   @relation(fields: [order_id], references: [id])
  invoice_items  customer_invoice_items[]
}

model customer_invoice_items {
  id          Int               @id @default(autoincrement())
  invoice_id  Int
  description String            @db.VarChar(255)
  quantity    Float
  unit        String            @db.VarChar(20)
  unit_price  Int
  amount      Int
  created_at  DateTime          @default(now())
  invoice     customer_invoices @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
}

model fee_plans {
  id               Int        @id @default(autoincrement())
  name             String     @db.VarChar(100)
  monthly_fee      Int?
  per_order_fee    Int?
  per_project_fee  Int?
  project_fee_rate Float?
  is_default       Boolean    @default(false)
  created_at       DateTime   @default(now())
  updated_at       DateTime   @updatedAt
  partners         partners[]
}

model company_invoices {
  id                   Int                     @id @default(autoincrement())
  invoice_number       String                  @unique @db.VarChar(50)
  partner_id           Int
  issue_date           DateTime                @db.Date
  due_date             DateTime                @db.Date
  billing_period_start DateTime                @db.Date
  billing_period_end   DateTime                @db.Date
  total_amount         Int
  tax_amount           Int
  grand_total          Int
  status               InvoiceStatus           @default(UNPAID)
  payment_date         DateTime?               @db.Date
  created_at           DateTime                @default(now())
  updated_at           DateTime                @updatedAt
  partner              partners                @relation(fields: [partner_id], references: [id])
  invoice_items        company_invoice_items[]
}

model company_invoice_items {
  id               Int              @id @default(autoincrement())
  invoice_id       Int
  description      String           @db.VarChar(255)
  amount           Int
  related_order_id Int?
  created_at       DateTime         @default(now())
  invoice          company_invoices @relation(fields: [invoice_id], references: [id], onDelete: Cascade)
}

model system_settings {
  id            Int      @id @default(autoincrement())
  setting_key   String   @unique @db.VarChar(100)
  setting_value String   @db.VarChar(255)
  description   String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
}

model company_settings {
  id                          Int      @id @default(autoincrement())
  company_name                String   @db.VarChar(255)
  postal_code                 String?  @db.VarChar(10)
  address                     String?  @db.Text
  phone                       String?  @db.VarChar(20)
  email                       String?  @db.VarChar(255)
  invoice_registration_number String?  @db.VarChar(20)
  bank_name                   String?  @db.VarChar(100)
  bank_branch_name            String?  @db.VarChar(100)
  bank_account_type           String?  @db.VarChar(20)
  bank_account_number         String?  @db.VarChar(20)
  bank_account_holder         String?  @db.VarChar(100)
  created_at                  DateTime @default(now())
  updated_at                  DateTime @updatedAt
}

// ===== 新規追加: 保証金・紹介システム関連 =====

enum DepositTransactionType {
  DEPOSIT // 入金
  DEDUCTION // 引き落とし
}

enum DepositRequestStatus {
  PENDING // 申請中
  APPROVED // 承認済み
  REJECTED // 却下
}

model DepositHistory {
  id           String                 @id @default(cuid())
  partner_id   Int                    @map("partner_id")
  partner      partners               @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  amount       Int // 金額（プラス=入金、マイナス=引き落とし）
  type         DepositTransactionType // 取引タイプ
  balance      Int // 取引後残高
  description  String?                @db.Text // 説明
  diagnosis_id Int?                   @map("diagnosis_id") // 紹介料引き落としの場合の診断ID
  diagnosis    diagnosis_requests?    @relation(fields: [diagnosis_id], references: [id])
  created_at   DateTime               @default(now()) @map("created_at")

  @@index([partner_id])
  @@index([diagnosis_id])
  @@map("deposit_history")
}

model DepositRequest {
  id               String               @id @default(cuid())
  partner_id       Int                  @map("partner_id")
  partner          partners             @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  requested_amount Int                  @map("requested_amount") // 申請金額
  approved_amount  Int?                 @map("approved_amount") // 承認金額
  status           DepositRequestStatus @default(PENDING)
  partner_note     String?              @map("partner_note") @db.Text // 加盟店のメモ
  admin_note       String?              @map("admin_note") @db.Text // 管理者のメモ
  created_at       DateTime             @default(now()) @map("created_at")
  approved_at      DateTime?            @map("approved_at")
  approved_by      Int?                 @map("approved_by") // 承認した管理者ID
  admin            Admin?               @relation(fields: [approved_by], references: [id])

  @@index([partner_id])
  @@index([status])
  @@map("deposit_requests")
}

model Referral {
  id            String             @id @default(cuid())
  diagnosis_id  Int                @map("diagnosis_id")
  diagnosis     diagnosis_requests @relation(fields: [diagnosis_id], references: [id], onDelete: Cascade)
  partner_id    Int                @map("partner_id")
  partner       partners           @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  referral_fee  Int                @map("referral_fee") // 紹介料
  email_sent    Boolean            @default(false) @map("email_sent")
  email_sent_at DateTime?          @map("email_sent_at")
  created_at    DateTime           @default(now()) @map("created_at")

  @@unique([diagnosis_id, partner_id])
  @@index([diagnosis_id])
  @@index([partner_id])
  @@map("referrals")
}
