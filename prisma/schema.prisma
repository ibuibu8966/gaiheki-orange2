generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Admin {
  id                           Int                            @id @default(autoincrement())
  username                     String                         @unique @db.VarChar(50)
  email                        String                         @unique @db.VarChar(100)
  passwordHash                 String                         @map("password_hash") @db.VarChar(255)
  role                         AdminRole                      @default(ADMIN)
  isActive                     Boolean                        @default(true) @map("is_active")
  lastLoginAt                  DateTime?                      @map("last_login_at")
  createdAt                    DateTime                       @default(now()) @map("created_at")
  updatedAt                    DateTime                       @updatedAt @map("updated_at")
  sessions                     AdminSession[]
  application_status_histories application_status_histories[]
  articles                     articles[]
  partner_applications         partner_applications[]
  deposit_requests             DepositRequest[]

  @@map("admins")
}

model AdminSession {
  id        String   @id @default(cuid())
  adminId   Int      @map("admin_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([expiresAt])
  @@map("admin_sessions")
}

model application_status_histories {
  id                   Int                  @id @default(autoincrement())
  application_id       Int
  previous_status      ApplicationStatus?
  new_status           ApplicationStatus
  changed_by           Int
  change_reason        String?
  created_at           DateTime             @default(now())
  partner_applications partner_applications @relation(fields: [application_id], references: [id], onDelete: Cascade)
  admins               Admin                @relation(fields: [changed_by], references: [id])
}

model articles {
  id              Int             @id @default(autoincrement())
  admin_id        Int
  title           String          @db.VarChar(200)
  thumbnail_image String?         @db.Text
  category        ArticleCategory
  content         String          @db.Text
  is_published    Boolean         @default(false)
  sort_order      Int             @default(0)
  post_name       String          @db.VarChar(100)
  created_at      DateTime        @default(now())
  updated_at      DateTime
  admins          Admin           @relation(fields: [admin_id], references: [id])

  @@index([is_published])
  @@index([category])
  @@index([sort_order])
}

// customersテーブルは削除（顧客管理機能は不要）

model diagnosis_requests {
  id                    Int              @id @default(autoincrement())
  diagnosis_number      String           @unique @db.VarChar(20)
  designated_partner_id Int?
  prefecture            Prefecture
  floor_area            FloorArea
  current_situation     CurrentSituation
  construction_type     ConstructionType
  created_at            DateTime         @default(now())
  updated_at            DateTime

  // 顧客情報（customersテーブル削除に伴い直接保持）
  customer_name           String  @map("customer_name") @db.VarChar(100)
  customer_phone          String  @map("customer_phone") @db.VarChar(20)
  customer_email          String? @map("customer_email") @db.VarChar(150)

  // 新規追加フィールド（ヒアリング情報・紹介システム）
  customer_enthusiasm     Int?    @map("customer_enthusiasm") @db.SmallInt
  desired_partner_count   Int?    @default(3) @map("desired_partner_count")
  referral_fee            Int     @default(30000) @map("referral_fee")
  admin_note              String? @map("admin_note") @db.Text
  customer_address        String? @map("customer_address") @db.VarChar(500)
  customer_phone_verified String? @map("customer_phone_verified") @db.VarChar(20)

  designated_partner partners?        @relation("DesignatedDiagnoses", fields: [designated_partner_id], references: [id])
  referrals          Referral[]
  deposit_histories  DepositHistory[]

  @@index([prefecture])
  @@index([created_at])
  @@index([designated_partner_id])
}

model inquiries {
  id              Int           @id @default(autoincrement())
  customer_name   String        @db.VarChar(100)
  customer_email  String        @db.VarChar(150)
  customer_phone  String?       @db.VarChar(20)
  subject         String        @db.VarChar(200)
  inquiry_content String
  inquiry_status  InquiryStatus @default(PENDING)
  admin_memo      String?
  created_at      DateTime      @default(now())
  updated_at      DateTime

  @@index([inquiry_status])
  @@index([created_at])
  @@map("inquiries")
}

// orders, order_photosテーブルは削除（注文・施工管理機能は不要）

model partner_application_prefectures {
  id                   Int                  @id @default(autoincrement())
  partner_id           Int
  supported_prefecture Prefecture
  created_at           DateTime             @default(now())
  partner_applications partner_applications @relation(fields: [partner_id], references: [id], onDelete: Cascade)

  @@unique([partner_id, supported_prefecture])
}

model partner_applications {
  id                              Int                               @id @default(autoincrement())
  company_name                    String                            @db.VarChar(200)
  representative_name             String                            @db.VarChar(100)
  address                         String                            @db.VarChar(500)
  phone_number                    String                            @db.VarChar(20)
  email                           String                            @db.VarChar(150)
  website_url                     String?                           @db.VarChar(500)
  business_description            String
  self_pr                         String
  application_status              ApplicationStatus                 @default(UNDER_REVIEW)
  admin_memo                      String?
  review_notes                    String?
  reviewed_by                     Int?
  reviewed_at                     DateTime?
  created_at                      DateTime                          @default(now())
  updated_at                      DateTime
  application_status_histories    application_status_histories[]
  partner_application_prefectures partner_application_prefectures[]
  admins                          Admin?                            @relation(fields: [reviewed_by], references: [id])

  @@index([application_status])
  @@index([created_at])
}

model partner_details {
  id                          Int            @id @default(autoincrement())
  partner_id                  Int            @unique
  company_name                String         @db.VarChar(200)
  phone_number                String         @db.VarChar(20)
  address                     String         @db.VarChar(500)
  representative_name         String         @db.VarChar(100)
  fax_number                  String?        @db.VarChar(20)
  website_url                 String?        @db.VarChar(500)
  business_description        String
  appeal_text                 String
  business_hours              String?        @db.VarChar(200)
  closed_days                 String?        @db.VarChar(200)
  site_reprint_prefecture     Prefecture?
  partners_status             PartnersStatus @default(INACTIVE)
  invoice_registration_number String?        @db.VarChar(50)
  bank_name                   String?        @db.VarChar(255)
  bank_branch_name            String?        @db.VarChar(255)
  bank_account_type           String?        @db.VarChar(50)
  bank_account_number         String?        @db.VarChar(50)
  bank_account_holder         String?        @db.VarChar(255)
  created_at                  DateTime       @default(now())
  updated_at                  DateTime
  partners                    partners       @relation(fields: [partner_id], references: [id], onDelete: Cascade)

  @@index([partners_status])
}

model partner_prefectures {
  id                   Int        @id @default(autoincrement())
  partner_id           Int
  supported_prefecture Prefecture
  created_at           DateTime   @default(now())
  updated_at           DateTime
  partners             partners   @relation(fields: [partner_id], references: [id], onDelete: Cascade)

  @@unique([partner_id, supported_prefecture])
}

model partners {
  id            Int       @id @default(autoincrement())
  username      String    @unique @db.VarChar(100)
  login_email   String    @unique @db.VarChar(150)
  password_hash String    @db.VarChar(255)
  is_active     Boolean   @default(true)
  last_login_at DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime

  // 新規追加フィールド（保証金・紹介システム）
  deposit_balance       Int       @default(0) @map("deposit_balance")
  monthly_desired_leads Int?      @map("monthly_desired_leads")
  monthly_leads_count   Int       @default(0) @map("monthly_leads_count")
  last_leads_reset      DateTime? @map("last_leads_reset")

  partner_details      partner_details?
  partner_prefectures  partner_prefectures[]
  designated_diagnoses diagnosis_requests[]  @relation("DesignatedDiagnoses")
  deposit_histories    DepositHistory[]
  deposit_requests     DepositRequest[]
  referrals            Referral[]

  @@index([is_active])
}

// quotationsテーブルは削除（見積もり提出機能は不要）

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  OPERATOR
}

enum ApplicationStatus {
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum ArticleCategory {
  BASIC_KNOWLEDGE
  PAINT_TYPES
  CASE_STUDIES
  MAINTENANCE
  CONTRACTOR_SELECTION
  COST_ESTIMATE
  TROUBLESHOOTING
  SEASONAL_WEATHER
}

enum ConstructionType {
  EXTERIOR_PAINTING
  ROOF_PAINTING
  SCAFFOLDING_WORK
  WATERPROOFING
  LARGE_SCALE_WORK
  INTERIOR_WORK
  EXTERIOR_WORK
  OTHER
}

enum CurrentSituation {
  MARKET_RESEARCH
  CONSIDERING_CONSTRUCTION
  COMPARING_CONTRACTORS
  READY_TO_ORDER
  CONSTRUCTION_COMPLETED
}

// CustomerConstructionType, CustomerStatus enumは削除（customersテーブル削除に伴い不要）

// DiagnosisStatus enum は削除されました

enum FloorArea {
  UNKNOWN
  UNDER_80
  FROM_80_TO_100
  FROM_101_TO_120
  FROM_121_TO_140
  FROM_141_TO_160
  FROM_161_TO_180
  FROM_181_TO_200
  FROM_201_TO_250
  FROM_251_TO_300
  FROM_301_TO_500
  OVER_501
}

enum InquiryStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

// OrderStatus enumは削除（ordersテーブル削除に伴い不要）

enum PartnersStatus {
  ACTIVE
  INACTIVE
}

enum Prefecture {
  Hokkaido
  Aomori
  Iwate
  Miyagi
  Akita
  Yamagata
  Fukushima
  Ibaraki
  Tochigi
  Gunma
  Saitama
  Chiba
  Tokyo
  Kanagawa
  Niigata
  Toyama
  Ishikawa
  Fukui
  Yamanashi
  Nagano
  Gifu
  Shizuoka
  Aichi
  Mie
  Shiga
  Kyoto
  Osaka
  Hyogo
  Nara
  Wakayama
  Tottori
  Shimane
  Okayama
  Hiroshima
  Yamaguchi
  Tokushima
  Kagawa
  Ehime
  Kochi
  Fukuoka
  Saga
  Nagasaki
  Kumamoto
  Oita
  Miyazaki
  Kagoshima
  Okinawa
}

// InvoiceStatus enumは削除（請求書機能は不要）
// customer_invoices, customer_invoice_items, company_invoices, company_invoice_itemsテーブルは削除（請求書機能は不要）
// fee_plans, system_settings, company_settingsテーブルは削除（システム設定機能は不要）

// ===== 新規追加: 保証金・紹介システム関連 =====

enum DepositTransactionType {
  DEPOSIT // 入金
  DEDUCTION // 引き落とし
}

enum DepositRequestStatus {
  PENDING // 申請中
  APPROVED // 承認済み
  REJECTED // 却下
}

model DepositHistory {
  id           String                 @id @default(cuid())
  partner_id   Int                    @map("partner_id")
  partner      partners               @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  amount       Int // 金額（プラス=入金、マイナス=引き落とし）
  type         DepositTransactionType // 取引タイプ
  balance      Int // 取引後残高
  description  String?                @db.Text // 説明
  diagnosis_id Int?                   @map("diagnosis_id") // 紹介料引き落としの場合の診断ID
  diagnosis    diagnosis_requests?    @relation(fields: [diagnosis_id], references: [id])
  created_at   DateTime               @default(now()) @map("created_at")

  @@index([partner_id])
  @@index([diagnosis_id])
  @@map("deposit_history")
}

model DepositRequest {
  id               String               @id @default(cuid())
  partner_id       Int                  @map("partner_id")
  partner          partners             @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  requested_amount Int                  @map("requested_amount") // 申請金額
  approved_amount  Int?                 @map("approved_amount") // 承認金額
  status           DepositRequestStatus @default(PENDING)
  partner_note     String?              @map("partner_note") @db.Text // 加盟店のメモ
  admin_note       String?              @map("admin_note") @db.Text // 管理者のメモ
  created_at       DateTime             @default(now()) @map("created_at")
  approved_at      DateTime?            @map("approved_at")
  approved_by      Int?                 @map("approved_by") // 承認した管理者ID
  admin            Admin?               @relation(fields: [approved_by], references: [id])

  @@index([partner_id])
  @@index([status])
  @@map("deposit_requests")
}

model Referral {
  id            String             @id @default(cuid())
  diagnosis_id  Int                @map("diagnosis_id")
  diagnosis     diagnosis_requests @relation(fields: [diagnosis_id], references: [id], onDelete: Cascade)
  partner_id    Int                @map("partner_id")
  partner       partners           @relation(fields: [partner_id], references: [id], onDelete: Cascade)
  referral_fee  Int                @map("referral_fee") // 紹介料
  email_sent    Boolean            @default(false) @map("email_sent")
  email_sent_at DateTime?          @map("email_sent_at")
  created_at    DateTime           @default(now()) @map("created_at")

  @@unique([diagnosis_id, partner_id])
  @@index([diagnosis_id])
  @@index([partner_id])
  @@map("referrals")
}

// ===== システム設定 =====
model SystemSettings {
  id          Int      @id @default(autoincrement())
  key         String   @unique @db.VarChar(100)
  value       String   @db.Text
  description String?  @db.Text
  created_at  DateTime @default(now()) @map("created_at")
  updated_at  DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}
